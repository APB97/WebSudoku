@using apb97.github.io.WebSudoku.Services

@inject IJSRuntime JS

<UtilitiesProvider @ref="utilitiesModule" />

<LocalizedComponent T="LanguageSelect" Context="Loc" @ref="localizer">
    <label for="language" class="text-white" hidden="@Loc.IsLoading">
        @Loc["Select your locale"]:
    </label>
    <InputSelect id="language" hidden="@Loc.IsLoading" style="background-color: transparent; border: none; color: white;" TValue="string" DisplayName="Language" Value="@Culture" ValueChanged="UpdateLocalizationAsync" ValueExpression="() => Culture">
        @foreach (var culture in supportedCultures)
        {
            <option value="@culture.Value" class="@(culture.Value == Culture ? "current" : null)">@culture.Key</option>
        }
    </InputSelect>
</LocalizedComponent>

@code
{
    private static string? currentCulture;

    public string? Culture { get => currentCulture; private set => currentCulture = value; }

    private IJSObjectReference? utilitiesModule;
    private LocalizedComponent<LanguageSelect>? localizer;

    private readonly static IReadOnlyDictionary<string, string> supportedCultures = new Dictionary<string, string>
    {
        { "English", "en-US" },
        { "Polski", "pl-PL" }
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        if (utilitiesModule is null) return;

        await UpdateLocalizationAsync(await utilitiesModule.GetSettingAsync<string>("BlazorCulture") ?? "en-US");
    }

    private async Task UpdateLocalizationAsync(string value)
    {
        if (Culture == value) return;
        Culture = value ?? "en-US";
        if (localizer is not null)
        {
            await localizer.Loc.InitializeAsync(value);
            await localizer.Layout.NotifyStateChanged();
        }

        if (utilitiesModule is null) return;
        await utilitiesModule.SetSettingAsync("BlazorCulture", value);
    }
}